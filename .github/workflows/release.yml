name: Release

on:
  schedule:
    - cron: "0 * * * *"
  push:
    branches:
      - master

jobs:
  check-update:
    name: 检查微信读书核心js是否有更新
    if: github.repository == 'jooooock/wrx'
    runs-on: ubuntu-latest

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装依赖
        run: yarn

      - name: 检查微信读书是否更新
        run: node ./scripts/weread/check-update.js

  build:
    name: 打包发布
    needs: check-update
    runs-on: ubuntu-latest

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 安装依赖
        run: yarn

      - name: 执行构建
        id: build
        run: |
          node ./scripts/weread/check-update.js
          node ./scripts/weread/patch.js
          node ./scripts/weread/build.js
          echo "version=v$(jq -r .version latest.json)" >> "$GITHUB_OUTPUT"

      - name: 输出构建结果
        run: |
          echo "build result: ${{ toJSON(steps.build.outputs) }}"

      - name: 提交代码
        run: |
          git config --global user.name Jock
          git config --global user.email findsource@proton.me
          git add .
          git commit -m "release $(echo $version)"
          git tag $(echo $version)
          git pull
          git push origin master
          git push --tags

      - name: 发布 Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "releases/wrx-${{ steps.build.outputs.version }}.zip"
          tag: "${{ steps.build.outputs.version }}"
